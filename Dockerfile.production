# ByNoemie RAG Chatbot - Production Dockerfile
# Fixed for flat project structure (no src/ folder)

FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first (for better caching)
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Create directory structure FIRST
RUN mkdir -p src data/products data/stock data/orders data/embeddings data/policies data/cache

# Copy all Python files
COPY *.py ./

# Copy config and data files
COPY *.yaml ./ 2>/dev/null || true
COPY *.json ./ 2>/dev/null || true
COPY *.html ./ 2>/dev/null || true

# Setup src/ directory for imports (api.py imports from src.agents)
RUN cp agents.py src/ 2>/dev/null || true && \
    cp orders.py src/ 2>/dev/null || true && \
    cp policy_rag.py src/ 2>/dev/null || true && \
    cp database.py src/ 2>/dev/null || true && \
    cp data_manager.py src/ 2>/dev/null || true && \
    cp cache.py src/ 2>/dev/null || true && \
    cp logger.py src/ 2>/dev/null || true && \
    cp utils.py src/ 2>/dev/null || true && \
    cp base.py src/ 2>/dev/null || true && \
    cp openai_client.py src/ 2>/dev/null || true && \
    cp groq_client.py src/ 2>/dev/null || true && \
    cp templates.py src/ 2>/dev/null || true && \
    cp rules.py src/ 2>/dev/null || true && \
    cp workflow.py src/ 2>/dev/null || true && \
    cp chainer.py src/ 2>/dev/null || true && \
    cp error_handler.py src/ 2>/dev/null || true && \
    cp rate_limiter.py src/ 2>/dev/null || true && \
    cp token_counter.py src/ 2>/dev/null || true && \
    cp few_shot.py src/ 2>/dev/null || true && \
    cp data_processor.py src/ 2>/dev/null || true && \
    cp scraper.py src/ 2>/dev/null || true && \
    echo "" > src/__init__.py

# Setup data directories with JSON files
RUN cp bynoemie_products.json data/products/ 2>/dev/null || true && \
    cp stock_inventory.json data/stock/ 2>/dev/null || true && \
    cp sample_orders.json data/orders/ 2>/dev/null || true && \
    cp policies.json data/policies/ 2>/dev/null || true

# Environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app \
    PORT=8501

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=15s --retries=3 \
    CMD curl -f http://localhost:${PORT}/health || exit 1

# Expose port
EXPOSE ${PORT}

# Run the API
CMD ["sh", "-c", "uvicorn api:app --host 0.0.0.0 --port ${PORT}"]